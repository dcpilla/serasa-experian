---
- include_tasks: check_token_time.yml      

- name: include autentication
#  include_tasks: roles/aws/tasks/sts_connection.yml
  include_role:
    name: aws
    tasks_from: sts_connection
  

# - name: garente xlsx2csv
#   shell: '{{item}}'
#   with_items:
#     - 'python3.11 -m ensurepip --default-pip'
#     - 'python3.11 -m pip install xlsx2csv'


# - name: convert {{csv_file}} to {{file_converted}}
#   shell: 'xlsx2csv ~/Containers.xlsx  > ~/Containers.csv'
#
#
- name: select found
  shell: "grep {{account_id}} /home/Check/container_vulnerability_search.txt | cut -d '|' -f3 | cut -d ':' -f2 > /tmp/removeresses.txt"

- name: remove found 
  shell: "for V in `cat /tmp/removeresses.txt`; do sed -i /$V/d /home/svi4808-a/Containers.csv; echo ''; done"

    
- name: get only our accounts
  shell: "cat /home/svi4808-a/Containers.csv | egrep '187739130313|153056696998|564593125549|530914589075|662860092544|146737708860|504195663072|306716481758|877001948254|087086536124|353091569218|415071355886|992382670558|975050357449' |cut -d ':' -f2|cut -d ',' -f1,2|sort -u  > /home/svi4808-a/vulnera_container.csv"


- name: load csv /home/svi4808-a/vulnera_container.csv only current account
  ignore_errors: yes
  shell: "cat /home/svi4808-a/vulnera_container.csv | cut -d ':' -f2| cut -d ',' -f1,2 | sort -u| egrep -v 'DetectionHost|CloudAccountID'|grep {{account_id}}"
#   community.general.read_csv:
#     path: '{{file_converted}}'
#     fieldnames: VulnerabilityName,DetectionHost,CloudAccountID,DaysUntilDueDateCalc
#     delimiter: ','
  register: vulnera_container_list


# - name: get accounts
#   shell: "cat /home/svi4808-a/vulnera_container.csv |cut -d ',' -f2 |egrep -v 'DetectionHost,|CloudAccountID' | sort -u"
#   register: container_accounts

# - name: check accounts auph
#   include_tasks: container_vulnerability_check_accounts_autentic.yml
#   loop: '{{container_accounts.stdout_lines}}'
#   loop_control:
#     loop_var: container_account_id   


- debug:
    var: vulnera_container_list

- name: block get detail
  block:
    - name: set marc
      lineinfile:
        path: '{{container_vulnerability_search}}'
        line:  '{{item}}'
        state: present
      with_items:
        - '######################################################################### ACCOUNT {{account}} #########################################################################'      
        - '######################################################################### {{ansible_date_time.date}}-{{ansible_date_time.time}} #########################################################################'

    - name: get details 
      include_tasks: container_vulnerability_get.yml
      with_items:
        - '{{ vulnera_container_list.stdout_lines }}'
          #         - '4523827f651b5bc17c63c1239b668647d107db7a9616ea5f1d15c1f43f915530_087086536124,087086536124'
          #         - '4523827f651b5bc17c63c1239b668647d107db7a9616ea5f1d15c1f43f915530_530914589075,530914589075'
          #         - '4523827f651b5bc17c63c1239b668647d107db7a9616ea5f1d15c1f43f915530_662860092544,662860092544'
          #         - '4523827f651b5bc17c63c1239b668647d107db7a9616ea5f1d15c1f43f915530_877001948254,877001948254'
      loop_control:
        loop_var: container

  when: vulnera_container_list is defined and vulnera_container_list.failed == false


###SDG###

