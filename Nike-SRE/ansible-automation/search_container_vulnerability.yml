---
- name: list cluster
  become: false
  shell: "/usr/local/bin/aws eks list-clusters --region {{account_region}} --profile={{account}}"
  register: eks_cluster_list

- name: convert to json
  set_fact:
    eks_cluster_list: '{{eks_cluster_list.stdout|from_json}}'

- debug:
    var: eks_cluster_list.clusters


- name: set fact found false 
  set_fact:
    found: false

- debug:
    var: found

- name: get namespace of eks_cluster_list.clusters
  include_tasks: get_container_eks_name_spaces.yml
  with_items: '{{eks_cluster_list.clusters}}'
  loop_control:
    loop_var: cluster_name
  when: found == false
#  when: not (found.changed|d(false))


- name: add container definition in {{container_vulnerability_search}}
  block:
    - name: print n√£o encontrou
      debug:
        msg: 
          - "################################################################"
          - "##################      NOT FOUND SHA      #####################"
          - "##                                                            ##"
          - "## {{sha}}                                 ##"
          - "##                                                            ##"
          - "################################################################"

    - name: write NOT FOUND SHA in file  {{container_vulnerability_search}}
      lineinfile:
        path: '{{container_vulnerability_search}}'
        line: '{{account}}|{{account_id}}|NOT FOUND SHA: {{sha}}|{{ansible_date_time.date}}-{{ansible_date_time.time}}'
        state: present
        create: true
  when: found == false
#  when: poddescribe is defined and poddescribe.stdout == ''
    
###SDG###
